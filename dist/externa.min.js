/*! For license information please see externa.min.js.LICENSE.txt */
!function(n,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("machina"),require("debug")):"function"==typeof define&&define.amd?define(["machina","debug"],e):"object"==typeof exports?exports.externa=e(require("machina"),require("debug")):n.externa=e(n.machina,n.debug)}(this,(function(n,e){return(()=>{"use strict";var t={682:n=>{n.exports=e},264:e=>{e.exports=n}},i={};function r(n){var e=i[n];if(void 0!==e)return e.exports;var a=i[n]={exports:{}};return t[n](a,a.exports,r),a.exports}r.n=n=>{var e=n&&n.__esModule?()=>n.default:()=>n;return r.d(e,{a:e}),e},r.d=(n,e)=>{for(var t in e)r.o(e,t)&&!r.o(n,t)&&Object.defineProperty(n,t,{enumerable:!0,get:e[t]})},r.o=(n,e)=>Object.prototype.hasOwnProperty.call(n,e);var a={};return(()=>{function n(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=n[t];return i}function e(){for(var n=[],e="0123456789abcdef",t=0;t<36;t++)n[t]=e.substr(Math.floor(16*Math.random()),1);return n[14]="4",n[19]=e.substr(3&n[19]|8,1),n[8]=n[13]=n[18]=n[23]="-",n.join("")}r.d(a,{default:()=>x});const t={instanceId:e(),isWorker:"undefined"==typeof window&&!!postMessage&&!!location,knownExternals:new Map};var i,o=r(264),s=r.n(o),c=r(682),d=r.n(c),u=function(){},l={},f=s().Fsm.extend({initialize:function(n,e,t){this.target=e,this.instanceId=t,this.handshakeComplete=!1,this.logger=function(n){u("[remote-proxy] ".concat(n))}},initialState:"uninitialized",states:{uninitialized:{disconnect:"disconnected",sendPing:"pinging",receivePing:function(n){this.instanceId=n.instanceId},sendPong:function(){this.deferUntilTransition("ponging"),this.transition("ponging")}},pinging:{_onEnter:function(){var n={type:"externa.ping",timeStamp:new Date,ticket:e(),instanceId:t.instanceId};this.logger("pinging: ".concat(JSON.stringify(n))),this.send(n)},disconnect:"disconnected",receivePong:function(n){this.instanceId=n.instanceId,this.handshakeComplete=!0,this.logger("completed handshake with ".concat(this.instanceId)),this.transition("connected")},receivePing:function(n){this.instanceId=n.instanceId},sendPong:function(){this.deferUntilTransition("ponging"),this.transition("ponging")},receiveMessage:function(){this.deferUntilTransition("connected")},sendMessage:function(){this.deferUntilTransition("connected")}},ponging:{sendPong:function(n){var e,i,r,a,o=(i=(e=n).instanceId,r=e.timeStamp,a=e.ticket,{type:"externa.pong",instanceId:t.instanceId,timeStamp:new Date,pingData:{instanceId:i,timeStamp:r,ticket:a}});this.logger("ponging: ".concat(JSON.stringify(o))),this.send(o),this.transition("connected")}},connected:{ping:"pinging",disconnect:"disconnected",receiveMessage:function(n){this.logger("received message from ".concat(this.instanceId," ").concat(JSON.stringify(n)));var e=l[n.type];e?e(n.message):this.logger("no user handler for: ".concat(JSON.stringify(n)))},sendMessage:function(n,e){var i=function(n,e){return{type:"externa.message",instanceId:t.instanceId,timeStamp:new Date,envelope:{type:n,message:e}}}(n,e);this.logger("sending msg: ".concat(JSON.stringify(i))),this.send(i)}},disconnected:{_onEnter:function(){var n={type:"externa.disconnect",timeStamp:new Date,instanceId:t.instanceId};this.logger("sending disconnect: ".concat(JSON.stringify(n))),this.send(n)}}},sendPing:function(){this.handle("sendPing")},receivePing:function(n){this.handle("receivePing",n)},sendPong:function(n){this.handle("sendPong",n)},receivePong:function(n){this.handle("receivePong",n)},sendMessage:function(n,e){this.handle("sendMessage",n,e)},receiveMessage:function(n){var e=n.envelope;this.handle("receiveMessage",e)},send:function(n){this.target.postMessage({externa:!0,payload:n})},disconnect:function(){this.handle("disconnect")}});function g(){return i||(i=new(s().Fsm)({initialize:function(){this.logger=function(n){u("[window-adapter-fsm] ".concat(n))}},initialState:"uninitialized",states:{uninitialized:{init:"ready","externa.message":function(){this.logger("externa has not been initialized, but is receiving messages. Be sure to call externa.init()."),this.deferUntilTransition("ready")},"externa.ping":function(){this.logger("externa has not been initialized, but is receiving pings. Be sure to call externa.init()."),this.deferUntilTransition("ready")},"externa.pong":function(){this.logger("externa has not been initialized, but is receiving pongs. Be sure to call externa.init()."),this.deferUntilTransition("ready")}},ready:{pause:"paused","externa.message":function(n){var e=n.data,t=n.remote;this.logger("NORMAL MESSAGE FROM:",e.instanceId,t.state),t.receiveMessage(e)},"externa.ping":function(n){var e=n.data,t=n.remote;this.logger("PING MESSAGE FROM:",e.instanceId,t.state),t.receivePing(e),t.sendPong(e)},"externa.pong":function(n){var e=n.data,t=n.remote;this.logger("PONG MESSAGE FROM:",e.instanceId,t.state),t.receivePong(e)}},paused:{resume:"ready","externa.message":function(){this.deferUntilTransition("ready")},"externa.ping":function(){this.deferUntilTransition("ready")},"externa.pong":function(){this.deferUntilTransition("ready")}}},init:function(){this.handle("init")},pause:function(){this.handle("pause")},resume:function(){this.handle("resume")},handleMessage:function(n,e){this.handle(n,e)}})),i}function h(n){if(n.data.externa){var e=n.source,i=n.data.payload,r=t.knownExternals.get(e);r||(u("received externa message from unknown source: ".concat(i.instanceId)),r=new f({},e,i.instanceId),t.knownExternals.set(e,r)),g().handleMessage(i.type,{data:i,remote:r})}}function p(n,e,t,i,r,a,o){try{var s=n[a](o),c=s.value}catch(n){return void t(n)}s.done?e(c):Promise.resolve(c).then(i,r)}function m(n,e){return function(n){if(Array.isArray(n))return n}(n)||function(n,e){var t=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null!=t){var i,r,a=[],o=!0,s=!1;try{for(t=t.call(n);!(o=(i=t.next()).done)&&(a.push(i.value),!e||a.length!==e);o=!0);}catch(n){s=!0,r=n}finally{try{o||null==t.return||t.return()}finally{if(s)throw r}}return a}}(n,e)||v(n,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(n,e){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!t){if(Array.isArray(n)||(t=v(n))||e&&n&&"number"==typeof n.length){t&&(n=t);var i=0,r=function(){};return{s:r,n:function(){return i>=n.length?{done:!0}:{done:!1,value:n[i++]}},e:function(n){throw n},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){t=t.call(n)},n:function(){var n=t.next();return o=n.done,n},e:function(n){s=!0,a=n},f:function(){try{o||null==t.return||t.return()}finally{if(s)throw a}}}}function v(n,e){if(n){if("string"==typeof n)return w(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?w(n,e):void 0}}function w(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=n[t];return i}window.addEventListener("message",h);const x={knownExternals:t.knownExternals,init:function(n){var e,i;t.instanceId=n.instanceId||t.instanceId,e=t.instanceId,(u=d()("externa:".concat(e)))("initializing"),n.handlers?(i=n.handlers,l=i):console.warn("externa has not been configured with user handlers, so no inbound messages will be handled"),g().init()},connect:function(){u("connecting"),function(){if(t.isWorker)return[this];var e,i=(e=document.getElementsByTagName("iframe"),function(e){if(Array.isArray(e))return n(e)}(e)||function(n){if("undefined"!=typeof Symbol&&null!=n[Symbol.iterator]||null!=n["@@iterator"])return Array.from(n)}(e)||function(e,t){if(e){if("string"==typeof e)return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).map((function(n){return n.contentWindow}));return window.parent&&window.parent!==window&&i.push(window.parent),i}().forEach((function(n){var e=t.knownExternals.get(n);e||(e=new f({},n),t.knownExternals.set(n,e)),e.sendPing()}))},connectWorker:function(){},disconnect:function(){u("disconnecting"),window.removeEventListener("message",h);var n,e=y(t.knownExternals);try{for(e.s();!(n=e.n()).done;){var i=m(n.value,2);i[0],i[1].disconnect()}}catch(n){e.e(n)}finally{e.f()}t.knownExternals.clear()},resumeUponCompletion:function(n){return(e=regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return g().pause(),e.next=3,n();case 3:g().resume();case 4:case"end":return e.stop()}}),e)})),function(){var n=this,t=arguments;return new Promise((function(i,r){var a=e.apply(n,t);function o(n){p(a,i,r,o,s,"next",n)}function s(n){p(a,i,r,o,s,"throw",n)}o(void 0)}))})();var e},sendMessage:function(n,e){var i,r=y(t.knownExternals);try{for(r.s();!(i=r.n()).done;){var a=m(i.value,2);a[0],a[1].sendMessage(n,e)}}catch(n){r.e(n)}finally{r.f()}}}})(),a.default})()}));
//# sourceMappingURL=externa.min.js.map